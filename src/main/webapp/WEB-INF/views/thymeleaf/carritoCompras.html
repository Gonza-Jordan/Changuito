<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Carrito de Compras</title>
    <link rel="stylesheet" type="text/css" href="/spring/css/main.css">
    <!-- Boostrap core css -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
    />
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"
    ></script>
</head>
<body>
<header th:include="header.html" class="cabecera"></header>

<div class="carrito-container">
    <h1 class="carrito-title">Tu Carrito de Compras</h1>
    <div class="cantidad-productos">
        <p id="cantidad-productos" class="cantidad-texto" th:text="'Cantidad de productos en el carrito: ' + ${cantidadProductos}">Cantidad de productos en el carrito: 0</p>
    </div>
    <table class="carrito-table">
        <thead>
        <tr>
            <th>Foto</th>
            <th>Producto</th>
            <th>Precio Unitario</th>
            <th>Cantidad</th>
            <th>Categoría</th>
            <th>Subcategoría</th>
            <th>Acciones</th>
            <th>Precio producto total</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="producto, row : ${carrito}">
            <td><!-- Columna vacía para futura imagen --></td>
            <td th:text="${producto.nombre}">Nombre del Producto</td>
            <td>
                <span class="precio-unitario" th:text="${producto.precio}">Precio</span>
            </td>
            <td>
                <select class="cantidad-select">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </td>
            <td th:text="${producto.categoria}">Categoría</td>
            <td th:text="${producto.subcategoria}">Subcategoría</td>
            <td>
                <form th:action="@{/eliminar-del-carrito}" method="post">
                    <input type="hidden" name="codigoBarras" th:value="${producto.codigoBarras}" />
                    <button type="submit">Eliminar</button>
                </form>
            </td>
            <td>
                <span class="precio-total" th:text="${producto.precio}">Precio Total</span>
            </td>
        </tr>
        </tbody>
        <tfoot>
        <tr>
            <td colspan="6"></td>
            <td style="text-align: right;">Total:</td>
            <td id="total-final" colspan="2">0.00</td>
        </tr>
        </tfoot>
    </table>
</div>

<div class="d-flex justify-content-center align-items-center">
    <a th:href="@{/guardarCarrito}" class="btnLogin btn btn-sm btn-primary btn-block mb-4">Guardar carrito</a>
</div>

<footer th:include="footer.html"></footer>

<script type="text/javascript" src="/spring/js/main.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        actualizarTotal();

        var cantidadSelects = document.querySelectorAll('.cantidad-select');
        cantidadSelects.forEach(function(select) {
            select.addEventListener('change', function() {
                actualizarPrecioTotal(this.closest('tr'));
            });
        });
    });

    function actualizarPrecioTotal(row) {
        var precioUnitario = parseFloat(row.querySelector('.precio-unitario').innerText);
        var cantidad = parseInt(row.querySelector('.cantidad-select').value);
        var precioTotal = precioUnitario * cantidad;
        row.querySelector('.precio-total').innerText = precioTotal.toFixed(2);
        actualizarTotal();
    }

    function actualizarTotal() {
        var total = 0;
        var precios = document.querySelectorAll('.precio-total');
        precios.forEach(function(precio) {
            total += parseFloat(precio.innerText);
        });
        document.getElementById('total-final').innerText = total.toFixed(2);
    }

    function eliminarFila(button) {
        var row = button.closest('tr');
        row.parentNode.removeChild(row);
        actualizarTotal();
        actualizarCantidadProductos();
    }

    function actualizarCantidadProductos() {
        var cantidadProductos = document.querySelectorAll('.carrito-table tbody tr').length;
        document.getElementById('cantidad-productos').innerText = 'Cantidad de productos en el carrito: ' + cantidadProductos;
    }
</script>
</body>
</html>
