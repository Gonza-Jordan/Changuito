<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Carrito de Compras</title>
    <link rel="stylesheet" type="text/css" href="/spring/css/main.css">
    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<header th:include="header.html" class="cabecera"></header>

<div class="carrito-container">
    <h1 class="carrito-title">Tu Carrito de Compras</h1>
    <div class="cantidad-productos">
        <p id="cantidad-productos" class="cantidad-texto" th:text="'Cantidad de productos en el carrito: ' + ${cantidadProductos}"></p>
    </div>
    <table class="carrito-table">
        <thead>
        <tr>
            <th>Foto</th>
            <th>Producto</th>
            <th>Precio Unitario</th>
            <th>Cantidad</th>
            <th>Categoría</th>
            <th>Subcategoría</th>
            <th>Acciones</th>
            <th>Precio producto total</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="supermercadoProducto, row : ${carrito}">
            <td><!-- Columna vacía para futura imagen --></td>
            <td th:text="${supermercadoProducto.producto.nombre}"></td>
            <td>
                <span class="precio-unitario" th:text="${supermercadoProducto.precio}"></span>
            </td>
            <td>
                <select class="cantidad-select">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </td>
            <td th:text="${supermercadoProducto.producto.categoria}"></td>
            <td th:text="${supermercadoProducto.producto.subcategoria}"></td>
            <td>
                <form th:action="@{/eliminar-del-carrito}" method="post">
                    <input type="hidden" name="codigoBarras" th:value="${supermercadoProducto.producto.codigoBarras}" />
                    <button type="submit">Eliminar</button>
                </form>
            </td>
            <td>
                <span class="precio-total" th:text="${supermercadoProducto.precio}"></span>
            </td>
        </tr>
        </tbody>
        <tfoot>
        <tr>
            <td colspan="6"></td>
            <td style="text-align: right;">Total:</td>
            <td id="total-final" colspan="2"></td>
        </tr>
        </tfoot>
    </table>
    <div class="d-flex justify-content-center align-items-center">
        <button class="btn btn-success mb-4" data-bs-toggle="modal" data-bs-target="#modalPago">Pagar</button>
    </div>
    <div class="d-flex justify-content-center align-items-center">
        <a th:href="@{/guardarCarrito}" class="btn btn-primary btn-sm btn-block mb-4">Guardar carrito</a>
    </div>
</div>

<!-- Modal para datos de pago -->
<div class="modal fade" id="modalPago" tabindex="-1" aria-labelledby="modalPagoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPagoLabel">Datos de Pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formPago" novalidate>
                    <div class="mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoTarjeta" id="credito" value="credito" checked>
                            <label class="form-check-label" for="credito">Tarjeta de Crédito</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoTarjeta" id="debito" value="debito">
                            <label class="form-check-label" for="debito">Tarjeta de Débito</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="numeroTarjeta" class="form-label">Número de tarjeta</label>
                        <input type="text" class="form-control" id="numeroTarjeta" pattern="\\d{16}" maxlength="16" placeholder="1234 5678 9123 4567" required>
                        <div class="invalid-feedback">El número de tarjeta debe tener 16 dígitos.</div>
                    </div>
                    <div class="mb-3">
                        <label for="nombreTitular" class="form-label">Nombre del titular</label>
                        <input type="text" class="form-control" id="nombreTitular" pattern="[a-zA-Z\\s]+" placeholder="Nombre Apellido" required>
                        <div class="invalid-feedback">El nombre del titular debe contener solo letras y espacios.</div>
                    </div>
                    <div class="mb-3">
                        <label for="fechaVencimiento" class="form-label">Fecha de vencimiento</label>
                        <input type="month" class="form-control" id="fechaVencimiento" required>
                        <div class="invalid-feedback">Por favor, seleccione una fecha de vencimiento válida.</div>
                    </div>
                    <div class="mb-3">
                        <label for="codigoSeguridad" class="form-label">Código de seguridad</label>
                        <input type="password" class="form-control" id="codigoSeguridad" pattern="\\d{3}" maxlength="3" placeholder="123" required>
                        <div class="invalid-feedback">El código de seguridad debe tener 3 dígitos.</div>
                    </div>
                    <div class="mb-3">
                        <label for="domicilio" class="form-label">Domicilio</label>
                        <input type="text" class="form-control" id="domicilio" pattern="[a-zA-Z0-9\\s]+" placeholder="Calle Falsa 123" required>
                        <div class="invalid-feedback">Ingrese un domicilio válido sin caracteres especiales.</div>
                    </div>
                    <div class="mb-3">
                        <label for="codigoPostal" class="form-label">Código Postal</label>
                        <input type="text" class="form-control" id="codigoPostal" pattern="\\d{4}" maxlength="4" placeholder="1000" required>
                        <div class="invalid-feedback">El código postal debe tener 4 dígitos.</div>
                    </div>
                    <div class="mb-3">
                        <div class="mb-3">
                            <label for="totalPagar" class="form-label">Total a pagar: $</label>
                            <label id="totalPagar" class="form-label"></label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Realizar Pago</button>
                </form>
            </div>
        </div>
    </div>
</div>

<footer th:include="footer.html"></footer>

<script type="text/javascript" src="/spring/js/main.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        actualizarTotal();

        var cantidadSelects = document.querySelectorAll('.cantidad-select');
        cantidadSelects.forEach(function(select) {
            select.addEventListener('change', function() {
                actualizarPrecioTotal(this.closest('tr'));
            });
        });

        // Copiar el valor del total al abrir el modal
        document.querySelector('[data-bs-target="#modalPago"]').addEventListener('click', function() {
            document.getElementById('totalPagar').innerText = document.getElementById('total-final').innerText;
        });

        document.getElementById('formPago').addEventListener('submit', function(event) {
            const numeroTarjeta = document.getElementById('numeroTarjeta');
            const nombreTitular = document.getElementById('nombreTitular');
            const fechaVencimiento = document.getElementById('fechaVencimiento');
            const codigoSeguridad = document.getElementById('codigoSeguridad');
            const domicilio = document.getElementById('domicilio');
            const codigoPostal = document.getElementById('codigoPostal');

            // Validaciones del formulario
            if (!numeroTarjeta.value.match(/^\\d{16}$/)) {
                alert("El número de tarjeta debe tener 16 dígitos.");
                event.preventDefault();
                return false;
            }
            if (!nombreTitular.value.match(/^[a-zA-Z\\s]+$/)) {
                alert("El nombre del titular debe contener solo letras y espacios.");
                event.preventDefault();
                return false;
            }
            if (!codigoSeguridad.value.match(/^\\d{3}$/)) {
                alert("El código de seguridad debe tener 3 dígitos.");
                event.preventDefault();
                return false;
            }
            if (!domicilio.value.match(/^[a-zA-Z0-9\\s]+$/)) {
                alert("El domicilio no debe contener caracteres especiales.");
                event.preventDefault();
                return false;
            }
            if (!codigoPostal.value.match(/^\\d{4}$/)) {
                alert("El código postal debe tener 4 dígitos.");
                event.preventDefault();
                return false;
            }

            // Validar fecha de vencimiento
            const fechaVencimientoVal = new Date(fechaVencimiento.value);
            const fechaActual = new Date();
            fechaActual.setMonth(fechaActual.getMonth() + 1); // Ajustar a primer día del próximo mes
            fechaActual.setDate(1);

            if (fechaVencimientoVal < fechaActual) {
                alert("La tarjeta está vencida. Por favor, ingrese otra tarjeta.");
                event.preventDefault();
                return false;
            }
        });
    });

    function actualizarPrecioTotal(row) {
        var precioUnitario = parseFloat(row.querySelector('.precio-unitario').innerText);
        var cantidad = parseInt(row.querySelector('.cantidad-select').value);
        var precioTotal = precioUnitario * cantidad;
        row.querySelector('.precio-total').innerText = precioTotal.toFixed(2);
        actualizarTotal();
    }

    function actualizarTotal() {
        var total = 0;
        var precios = document.querySelectorAll('.precio-total');
        precios.forEach(function(precio) {
            total += parseFloat(precio.innerText);
        });
        document.getElementById('total-final').innerText = total.toFixed(2);
    }

    function eliminarFila(button) {
        var row = button.closest('tr');
        row.parentNode.removeChild(row);
        actualizarTotal();
        actualizarCantidadProductos();
    }

    function actualizarCantidadProductos() {
        var cantidadProductos = document.querySelectorAll('.carrito-table tbody tr').length;
        document.getElementById('cantidad-productos').innerText = 'Cantidad de productos en el carrito: ' + cantidadProductos;
    }
                // Mostrar mensaje de éxito y vaciar el carrito
            document.getElementById('mensajeExito').style.display = 'block';
            setTimeout(function() {
                window.location.href = '/spring/home'; // Redirigir a la página principal
                fetch('/spring/vaciarCarrito', { method: 'POST' });
            }, 2000);

</script>
</body>
</html>
